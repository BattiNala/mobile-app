name: Flutter Build (Android + iOS)

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
  workflow_dispatch:

env:
  FLUTTER_VERSION: "3.35.6"

jobs:
  android:
    name: Build Android
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true

      - run: flutter pub get
      - run: flutter test
      - run: flutter build apk --release
      - run: flutter build appbundle --release

      - name: Upload Android artifacts
        uses: actions/upload-artifact@v4
        with:
          name: android-build
          path: |
            build/app/outputs/flutter-apk/*.apk
            build/app/outputs/bundle/release/*.aab

  ios:
    name: Build iOS
    runs-on: macos-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true

      - run: flutter pub get
      - run: flutter build ios --release --no-codesign

      - name: Upload iOS build
        uses: actions/upload-artifact@v4
        with:
          name: ios-build
          path: build/ios

  notify:
    name: Discord Notification
    runs-on: ubuntu-latest
    needs: [android, ios]
    if: always()

    steps:
      - name: Notify Discord
        uses: Ilshidur/action-discord@v2
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
        with:
          args: |
            **Flutter CI Result**
            Repository: **${{ github.repository }}**
            Branch: **${{ github.ref_name }}**
            Commit: `${{ github.sha }}`
            Status: **${{ needs.android.result == 'success' && needs.ios.result == 'success' && '✅ SUCCESS' || '❌ FAILED' }}**
            Triggered by: **${{ github.actor }}**
            Run: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
